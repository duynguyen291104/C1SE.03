name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # ============================================
  # PR INFO & VALIDATION
  # ============================================
  pr-info:
    name: PR Information
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: PR Details
        run: |
          echo "üìã Pull Request Details"
          echo "Title: ${{ github.event.pull_request.title }}"
          echo "Author: ${{ github.event.pull_request.user.login }}"
          echo "Branch: ${{ github.head_ref }} ‚Üí ${{ github.base_ref }}"
          echo "Commits: ${{ github.event.pull_request.commits }}"
      
      - name: Check PR Title Format
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          if [[ $PR_TITLE =~ ^(feat|fix|docs|style|refactor|test|chore|perf)(\(.+\))?: ]]; then
            echo "‚úÖ PR title follows conventional commit format"
          else
            echo "‚ö†Ô∏è  PR title should follow: type(scope): description"
            echo "Examples: feat(auth): add login, fix(api): resolve timeout"
          fi
      
      - name: Check for large files
        run: |
          echo "Checking for large files..."
          git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | \
          while read file; do
            if [ -f "$file" ]; then
              size=$(wc -c < "$file")
              if [ $size -gt 1000000 ]; then
                echo "‚ö†Ô∏è  Large file detected: $file ($(($size/1024))KB)"
              fi
            fi
          done

  # ============================================
  # CODE QUALITY CHECKS
  # ============================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
      
      - name: Install dependencies
        run: |
          cd client && npm ci
          cd ../server && npm ci
      
      - name: Check code formatting
        run: |
          echo "Checking code formatting..."
          cd client && npx prettier --check "src/**/*.{js,jsx,css}" || echo "‚ö†Ô∏è  Client needs formatting"
          cd ../server && npx prettier --check "src/**/*.js" || echo "‚ö†Ô∏è  Server needs formatting"
      
      - name: Count TODO/FIXME comments
        run: |
          echo "üìù Checking for TODO/FIXME comments..."
          TODO_COUNT=$(git grep -i "TODO\|FIXME" -- "*.js" "*.jsx" | wc -l || echo "0")
          echo "Found $TODO_COUNT TODO/FIXME comments"
          if [ "$TODO_COUNT" -gt 50 ]; then
            echo "‚ö†Ô∏è  High number of TODO/FIXME comments"
          fi

  # ============================================
  # DEPENDENCY CHECK
  # ============================================
  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
      
      - name: Check for dependency updates
        run: |
          echo "Checking for outdated dependencies..."
          cd client
          echo "üì¶ Client Dependencies:"
          npm outdated || true
          cd ../server
          echo "üì¶ Server Dependencies:"
          npm outdated || true
      
      - name: Verify lockfiles
        run: |
          echo "Verifying package-lock.json files..."
          cd client && npm audit --audit-level=high || true
          cd ../server && npm audit --audit-level=high || true

  # ============================================
  # BUILD VERIFICATION
  # ============================================
  build-check:
    name: Build Verification
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
      
      - name: Build Client
        working-directory: ./client
        run: |
          npm ci
          npm run build
        env:
          CI: false
      
      - name: Check Server Syntax
        working-directory: ./server
        run: |
          npm ci
          node -c src/server.js
          echo "‚úÖ Server syntax check passed"

  # ============================================
  # FILE CHANGES ANALYSIS
  # ============================================
  changes-analysis:
    name: Analyze Changes
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Analyze changed files
        run: |
          echo "üìä File Changes Analysis"
          echo "========================"
          
          # Count changes by type
          JS_CHANGES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} HEAD | grep -E '\.(js|jsx)$' | wc -l)
          CSS_CHANGES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} HEAD | grep -E '\.css$' | wc -l)
          CONFIG_CHANGES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} HEAD | grep -E '(package\.json|docker-compose\.yml|\.yml)$' | wc -l)
          
          echo "JavaScript/JSX files: $JS_CHANGES"
          echo "CSS files: $CSS_CHANGES"
          echo "Config files: $CONFIG_CHANGES"
          
          # Check for sensitive files
          SENSITIVE=$(git diff --name-only ${{ github.event.pull_request.base.sha }} HEAD | grep -E '(\.env|secrets|credentials)' || echo "")
          if [ ! -z "$SENSITIVE" ]; then
            echo "‚ö†Ô∏è  WARNING: Sensitive files detected!"
            echo "$SENSITIVE"
          fi
      
      - name: Calculate code statistics
        run: |
          echo "üìà Code Statistics"
          echo "=================="
          
          ADDED=$(git diff --numstat ${{ github.event.pull_request.base.sha }} HEAD | awk '{sum+=$1} END {print sum}')
          DELETED=$(git diff --numstat ${{ github.event.pull_request.base.sha }} HEAD | awk '{sum+=$2} END {print sum}')
          
          echo "Lines added: $ADDED"
          echo "Lines deleted: $DELETED"
          echo "Net change: $(($ADDED - $DELETED))"

  # ============================================
  # AUTO LABELING
  # ============================================
  labeler:
    name: Auto Label PR
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Label based on changes
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const labels = new Set();
            
            files.forEach(file => {
              if (file.filename.startsWith('client/')) labels.add('client');
              if (file.filename.startsWith('server/')) labels.add('server');
              if (file.filename.includes('docker')) labels.add('docker');
              if (file.filename.includes('.md')) labels.add('documentation');
              if (file.filename.includes('test')) labels.add('tests');
              if (file.filename.includes('.github/workflows')) labels.add('ci/cd');
            });
            
            if (labels.size > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: Array.from(labels)
              });
            }

  # ============================================
  # PR SUMMARY COMMENT
  # ============================================
  pr-comment:
    name: PR Summary Comment
    runs-on: ubuntu-latest
    needs: [pr-info, code-quality, build-check, changes-analysis]
    if: always()
    permissions:
      pull-requests: write
    
    steps:
      - name: Create PR Comment
        uses: actions/github-script@v7
        with:
          script: |
            const status = {
              'pr-info': '${{ needs.pr-info.result }}',
              'code-quality': '${{ needs.code-quality.result }}',
              'build-check': '${{ needs.build-check.result }}',
              'changes-analysis': '${{ needs.changes-analysis.result }}'
            };
            
            const emoji = {
              'success': '‚úÖ',
              'failure': '‚ùå',
              'skipped': '‚è≠Ô∏è'
            };
            
            let comment = '## ü§ñ PR Check Results\n\n';
            comment += '| Check | Status |\n';
            comment += '|-------|--------|\n';
            
            for (const [job, result] of Object.entries(status)) {
              comment += `| ${job} | ${emoji[result] || '‚ö†Ô∏è'} ${result} |\n`;
            }
            
            comment += '\n---\n';
            comment += '*Automated checks by GitHub Actions*';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
